# Instruction

The DevOps team is working on automating file management between two S3 buckets. The task is to create a public S3 bucket for file uploads and a private S3 bucket for securely storing the files. A Lambda function will be triggered automatically whenever a file is uploaded to the public S3 bucket, which will copy the file to the private bucket. Additionally, logs of the operation will be stored in a DynamoDB table. The logs should include details such as the source bucket, destination bucket, and the object key of the file that was copied. This will help the team maintain better security and visibility for file transfers.

Create a public S3 bucket namedÂ  `datacenter-public-27433`. Ensure that the bucket allows public access to its objects.

Create a private S3 bucket namedÂ `datacenter-private-26642`. Ensure that the bucket does not allow public access.

Create a Lambda function namedÂ `datacenter-copyfunction`. This function should be triggered by uploads to the public S3 bucket and should copy the uploaded file to the private bucket. Create the necessary policies and a role namedÂ `lambda_execution_role`. Attach these policies to the role, and then link this role to the Lambda function.

`lambda-function.py`Â is already present under theÂ `/root/`Â directory on AWS client host, replaceÂ `REPLACE-WITH-YOUR-DYNAMODB-TABLE`Â andÂ `REPLACE-WITH-YOUR-PRIVATE-BUCKET`Â values.

Create a DynamoDB table namedÂ `datacenter-S3CopyLogs`Â with a partition keyÂ LogIDÂ (string). This table will store logs generated by the Lambda function, including details such as source bucket name, destination bucket name, and object key.

For testing upload the fileÂ `sample.zip`Â located in theÂ `/root`Â directory on the client host to the public S3 bucket. The Lambda function should trigger and copy the file to the private bucket.

Verify that the file has been successfully copied to the private bucket by checking the private bucket in the S3 console.

Verify that a log entry has been created in the DynamoDB table containing the file copy details.

# Solution

### **Step 1: Gather Environment Details**

First, grab your Account ID to use in the resource ARNs.

```bash
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

```

### **Step 2: Create Infrastructure (S3 & DynamoDB)**

```bash
# 1. Create Public Bucket & remove public access block
aws s3api create-bucket --bucket xfusion-public-27433 --region us-east-1
aws s3api delete-public-access-block --bucket xfusion-public-27433

# 2. Create Private Bucket
aws s3api create-bucket --bucket xfusion-private-26642 --region us-east-1

# 3. Create DynamoDB Table
aws dynamodb create-table \
    --table-name xfusion-S3CopyLogs \
    --attribute-definitions AttributeName=LogID,AttributeType=S \
    --key-schema AttributeName=LogID,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5

```

---

### **Step 3: IAM Role & Policy Setup**

```bash
# 1. Create Trust Policy
cat <<EOF > trust-policy.json
{
  "Version": "2012-10-17",
  "Statement": [{ "Effect": "Allow", "Principal": { "Service": "lambda.amazonaws.com" }, "Action": "sts:AssumeRole" }]
}
EOF

# 2. Create the Role
ROLE_ARN=$(aws iam create-role --role-name lambda_execution_role --assume-role-policy-document file://trust-policy.json --query 'Role.Arn' --output text)

# 3. Attach Full Access Policies (Easiest for Lab Validation)
aws iam attach-role-policy --role-name lambda_execution_role --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
aws iam attach-role-policy --role-name lambda_execution_role --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
aws iam attach-role-policy --role-name lambda_execution_role --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

```

---

### **Step 4: Prepare Code & Deploy Lambda**

We'll avoid the "zip path" issue by switching into the `/root` directory first.

```bash
# 1. Update the code file
sed -i 's/REPLACE-WITH-YOUR-DYNAMODB-TABLE/xfusion-S3CopyLogs/g' /root/lambda-function.py
sed -i 's/REPLACE-WITH-YOUR-PRIVATE-BUCKET/xfusion-private-26642/g' /root/lambda-function.py

# 2. Create a flat zip (Critical step!)
cd /root/
zip function.zip lambda-function.py

# 3. Create the function (Wait 10s for IAM to sync)
sleep 10
aws lambda create-function \
    --function-name xfusion-copyfunction \
    --runtime python3.9 \
    --handler lambda-function.lambda_handler \
    --role $ROLE_ARN \
    --zip-file fileb://function.zip

```

---

### **Step 5: Configure the Trigger (The Handshake)**

```bash
# 1. Grant S3 permission to wake up the Lambda
aws lambda add-permission \
    --function-name xfusion-copyfunction \
    --action lambda:InvokeFunction \
    --principal s3.amazonaws.com \
    --source-arn arn:aws:s3:::xfusion-public-27433 \
    --statement-id s3-trigger-xfusion

# 2. Create the Notification Config
cat <<EOF > notification.json
{
  "LambdaFunctionConfigurations": [
    {
      "LambdaFunctionArn": "arn:aws:lambda:us-east-1:$ACCOUNT_ID:function:xfusion-copyfunction",
      "Events": ["s3:ObjectCreated:*"]
    }
  ]
}
EOF

# 3. Apply Trigger to Public Bucket
aws s3api put-bucket-notification-configuration \
    --bucket xfusion-public-27433 \
    --notification-configuration file://notification.json

```

---

### **Step 6: Test & Verify**

```bash
# Upload the test file
aws s3 cp /root/sample.zip s3://xfusion-public-27433/
```

  ![8](https://github.com/user-attachments/assets/e2632da2-8f9a-4243-aa79-b675650ada58)

  ![9 1](https://github.com/user-attachments/assets/834cb02f-2948-46c2-a8c4-7c01e81338da)

  ![9 2](https://github.com/user-attachments/assets/35fe014d-2d09-4637-b7a6-7039849ae184)


```bash
# Verify Results (Wait 10 seconds)
echo "--- Private Bucket (Should show file) ---"
aws s3 ls s3://xfusion-private-26642/

echo "--- DynamoDB (Should show Count 1) ---"
aws dynamodb scan --table-name xfusion-S3CopyLogs --query "Count"

```
  ![9 3](https://github.com/user-attachments/assets/1779ac2a-7d16-404f-8b54-60053f9d5a59)


ðŸ‘‰[Dev.to](https://dev.to/hritikraj8804/aws-146-event-driven-automation-syncing-s3-buckets-with-lambda-dynamodb-5df6)
